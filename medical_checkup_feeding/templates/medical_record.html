{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Geist&family=Manrope:wght@400;600&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Rekam Medis Hewan | SIZOPI</title>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        .navbar {
            transition: all 0.3s ease;
        }
        .navbar-fixed {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .bg-texture {
            background-image: url("{% static 'images/texture-bg.jpg' %}");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.15;
        }
        .main-container {
            max-width: 1200px;
            width: 100%;
            padding: 2rem;
            background-color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .form-container {
            max-width: 700px;
            width: 100%;
            padding: 2rem;
            background-color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            position: relative; 
            z-index: 10000;
        }
        input, textarea, select {
            width: 100%;
            padding: 6px 10px;
            margin-top: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        textarea {
            min-height: 80px;
            resize: none;
        }
        .form-button {
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
        }
        .form-button:hover {
            background-color: #ED8764;
        }
        .alert {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; 
        }
        .hidden {
            display: none;
        }
        .health-status-healthy {
            color: #28a745;
            font-weight: bold;
        }
        .health-status-sick {
            color: #dc3545;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table th, table td {
            border: 1px solid #e0e0e0;
            padding: 0.75rem;
            text-align: left;
        }
        table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .action-button {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            margin-right: 0.25rem;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        .empty-state p {
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body class="relative bg-white text-gray-800">
    {% include "navbar.html" %}
    <div id="bg" class="bg-texture absolute inset-0 -z-10"></div>
    <div class="min-h-screen px-8 py-10 flex flex-col items-center max-w-7xl mx-auto">
        <div class="main-container space-y-6 w-full">
            <h2 class="text-3xl md:text-4xl font-extrabold text-[#883526] drop-shadow-md leading-tight text-center">
                Rekam Medis Hewan
            </h2>
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <label for="animal-select" class="text-lg font-semibold text-[#49241B]">Pilih Hewan:</label>
                    <select id="animal-select" class="w-64 text-lg">
                        <option value="" disabled selected>-- Pilih Hewan --</option>
                        {% for animal in animals %}
                            <option value="{{ animal.0 }}">{{ animal.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button id="add-record-btn" class="form-button bg-[#FBBE99] text-white font-semibold">
                    + Tambah Rekam Medis
                </button>
            </div>
            
            <div id="animal-info" class="bg-gray-50 p-6 rounded-lg shadow-sm hidden">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">Nama Hewan</p>
                        <p class="font-semibold text-lg" id="animal-name"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Spesies</p>
                        <p class="font-semibold text-lg" id="animal-species"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Status Kesehatan</p>
                        <p class="font-semibold text-lg" id="animal-status"></p>
                    </div>
                </div>
            </div>
            
            <div id="medical-records" class="mt-8">
                <h3 class="text-xl font-bold text-[#883526] mb-4">Riwayat Pemeriksaan</h3>
                
                <!-- Default state: Belum memilih hewan -->
                <div id="no-animal-selected" class="empty-state">
                    <h3>Silakan Pilih Hewan</h3>
                    <p>Pilih hewan dari dropdown di atas untuk melihat riwayat rekam medisnya.</p>
                </div>
                
                <!-- State: Hewan dipilih tapi belum ada rekam medis -->
                <div id="no-records" class="empty-state hidden">
                    <h3>Belum Ada Rekam Medis</h3>
                    <p>Belum ada rekam medis yang tercatat untuk hewan ini.</p>
                    <button onclick="document.getElementById('add-record-btn').click()" 
                            class="form-button bg-[#FBBE99] text-white font-semibold">
                        + Tambah Rekam Medis Pertama
                    </button>
                </div>
                
                <!-- Tabel rekam medis -->
                <div id="records-table" class="overflow-x-auto hidden">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>Tanggal Pemeriksaan</th>
                                <th>Nama Dokter</th>
                                <th>Status Kesehatan</th>
                                <th>Diagnosa</th>
                                <th>Pengobatan</th>
                                <th>Catatan Tindak Lanjut</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="records-tbody">
                            <!-- Data akan diisi via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Tambah Rekam Medis -->
    <div id="add-record-modal" class="modal hidden">
        <div class="form-container bg-white">
            <h3 class="text-2xl font-bold text-[#883526] drop-shadow-md leading-tight text-center mb-6">
                Tambah Rekam Medis
            </h3>
            <form method="post" action="{% url 'medical_checkup_feeding:add_medical_record' %}" class="space-y-6">
                {% csrf_token %}
                <div>
                    <label for="id_hewan" class="text-sm text-[#49241B]">Pilih Hewan:</label>
                    <select id="id_hewan" name="id_hewan" class="text-lg" required>
                        <option value="">-- Pilih Hewan --</option>
                        {% for animal in animals %}
                            <option value="{{ animal.0 }}">{{ animal.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="tanggal_pemeriksaan" class="text-sm text-[#49241B]">Tanggal Pemeriksaan:</label>
                    <input type="date" id="tanggal_pemeriksaan" name="tanggal_pemeriksaan" class="text-lg" required />
                </div>
                <div>
                    <label for="status_kesehatan" class="text-sm text-[#49241B]">Status Kesehatan:</label>
                    <select id="status_kesehatan" name="status_kesehatan" class="text-lg" required>
                        <option value="" disabled selected>-- Pilih Status --</option>
                        <option value="Sehat">Sehat</option>
                        <option value="Sakit">Sakit</option>
                    </select>
                </div>
                <div id="diagnosis-section" class="hidden">
                    <div>
                        <label for="diagnosis" class="text-sm text-[#49241B]">Diagnosa:</label>
                        <textarea id="diagnosis" name="diagnosis" class="text-lg w-full"></textarea>
                    </div>
                    <div class="mt-4">
                        <label for="pengobatan" class="text-sm text-[#49241B]">Pengobatan:</label>
                        <textarea id="pengobatan" name="pengobatan" class="text-lg w-full"></textarea>
                    </div>
                </div>
                <div class="flex justify-center gap-4 pt-4">
                    <button type="submit" class="form-button bg-[#FBBE99] text-white font-semibold">SIMPAN</button>
                    <button type="button" class="form-button bg-[#ED8764] text-white font-semibold close-modal">BATAL</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Edit Rekam Medis -->
    <div id="edit-record-modal" class="modal hidden">
        <div class="form-container bg-white">
            <h3 class="text-2xl font-bold text-[#883526] drop-shadow-md leading-tight text-center mb-6">
                Edit Rekam Medis
            </h3>
            <form method="post" id="edit-form" class="space-y-6">
                {% csrf_token %}
                <div>
                    <label for="diagnosis_baru" class="text-sm text-[#49241B]">Diagnosa: <span class="text-red-500">*</span></label>
                    <textarea id="diagnosis_baru" name="diagnosis_baru" class="text-lg w-full" required 
                            placeholder="Masukkan diagnosa baru atau perbarui diagnosa existing"></textarea>
                </div>
                <div>
                    <label for="pengobatan_baru" class="text-sm text-[#49241B]">Pengobatan: <span class="text-red-500">*</span></label>
                    <textarea id="pengobatan_baru" name="pengobatan_baru" class="text-lg w-full" required
                            placeholder="Masukkan pengobatan baru atau perbarui pengobatan existing"></textarea>
                </div>
                <div>
                    <label for="catatan_tindak_lanjut" class="text-sm text-[#49241B]">Catatan Tindak Lanjut: <span class="text-gray-500">(Opsional)</span></label>
                    <textarea id="catatan_tindak_lanjut" name="catatan_tindak_lanjut" class="text-lg w-full"
                            placeholder="Masukkan catatan tindak lanjut jika diperlukan"></textarea>
                </div>
                <div class="flex justify-center gap-4 pt-4">
                    <button type="submit" class="form-button bg-[#FBBE99] text-white font-semibold">SIMPAN</button>
                    <button type="button" class="form-button bg-[#ED8764] text-white font-semibold close-modal">BATAL</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Konfirmasi Hapus -->
    <div id="delete-record-modal" class="modal hidden">
        <div class="form-container bg-white">
            <h3 class="text-2xl font-bold text-[#883526] drop-shadow-md leading-tight text-center mb-6">
                Konfirmasi Penghapusan
            </h3>
            <p class="text-center text-lg mb-6">Apakah Anda yakin ingin menghapus rekam medis ini?</p>
            <form method="post" id="delete-form" class="space-y-6">
                {% csrf_token %}
                <div class="flex justify-center gap-4 pt-4">
                    <button type="submit" class="form-button bg-red-500 text-white font-semibold">YA</button>
                    <button type="button" class="form-button bg-gray-500 text-white font-semibold close-modal">TIDAK</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data hewan dan rekam medis dari backend
        const animalsData = {
            {% for animal in animals %}
                '{{ animal.0 }}': {
                    id: '{{ animal.0 }}',
                    name: '{{ animal.1 }}',
                    species: '{{ animal.2 }}',
                    health: '{{ animal.3 }}'
                },
            {% endfor %}
        };
        
        // Data rekam medis dari backend
        const medicalRecordsData = [
            {% for record in medical_records %}
                {
                    id_hewan: '{{ record.0 }}',
                    username_dh: '{{ record.1 }}',
                    tanggal_pemeriksaan: '{{ record.2|date:"Y-m-d" }}',
                    tanggal_display: '{{ record.2|date:"d F Y" }}',
                    diagnosis: '{{ record.3|default:"-" }}',
                    pengobatan: '{{ record.4|default:"-" }}',
                    status_kesehatan: '{{ record.5 }}',
                    catatan_tindak_lanjut: '{{ record.6|default:"-" }}',
                    nama_hewan: '{{ record.7 }}',
                    spesies: '{{ record.8 }}',
                    nama_dokter: '{{ record.9 }}'
                },
            {% endfor %}
        ];
        
        const animalSelect = document.getElementById('animal-select');
        const animalInfo = document.getElementById('animal-info');
        const statusKesehatan = document.getElementById('status_kesehatan');
        const diagnosisSection = document.getElementById('diagnosis-section');
        
        // Event listener untuk pemilihan hewan
        animalSelect.addEventListener('change', function() {
            const animalId = this.value;
            if (animalId && animalsData[animalId]) {
                displayAnimalInfo(animalId);
                loadMedicalRecords(animalId);
                animalInfo.classList.remove('hidden');
            } else {
                animalInfo.classList.add('hidden');
                showNoAnimalSelected();
            }
        });
        
        // Event listener untuk status kesehatan di modal
        statusKesehatan.addEventListener('change', function() {
            if (this.value === 'Sakit') {
                diagnosisSection.classList.remove('hidden');
                document.getElementById('diagnosis').setAttribute('required', true);
                document.getElementById('pengobatan').setAttribute('required', true);
            } else {
                diagnosisSection.classList.add('hidden');
                document.getElementById('diagnosis').removeAttribute('required');
                document.getElementById('pengobatan').removeAttribute('required');
            }
        });
        
        // Event listener untuk tombol tambah rekam medis
        document.getElementById('add-record-btn').addEventListener('click', function() {
            const animalId = animalSelect.value;
            if (!animalId) {
                alert('Silakan pilih hewan terlebih dahulu.');
                return;
            }
            
            // Set hewan yang dipilih di modal
            document.getElementById('id_hewan').value = animalId;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal_pemeriksaan').value = today;
            document.getElementById('tanggal_pemeriksaan').max = today;
            
            document.getElementById('add-record-modal').classList.remove('hidden');
        });
        
        // Event listener untuk close modal
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.add('hidden');
                });
            });
        });
        
        // Fungsi untuk menampilkan info hewan
        function displayAnimalInfo(animalId) {
            const animal = animalsData[animalId];
            document.getElementById('animal-name').textContent = animal.name;
            document.getElementById('animal-species').textContent = animal.species;
            
            const statusElement = document.getElementById('animal-status');
            statusElement.textContent = animal.health;
            statusElement.className = 'font-semibold text-lg';
            
            if (animal.health === 'Sehat') {
                statusElement.classList.add('health-status-healthy');
            } else if (animal.health === 'Sakit') {
                statusElement.classList.add('health-status-sick');
            }
        }
        
        // Fungsi untuk memuat rekam medis berdasarkan hewan yang dipilih
        function loadMedicalRecords(animalId) {
            const records = medicalRecordsData.filter(record => record.id_hewan === animalId);
            
            if (records.length === 0) {
                showNoRecords();
            } else {
                showRecordsTable(records);
            }
        }
        
        
        function showNoAnimalSelected() {
            document.getElementById('no-animal-selected').classList.remove('hidden');
            document.getElementById('no-records').classList.add('hidden');
            document.getElementById('records-table').classList.add('hidden');
        }
        
       
        function showNoRecords() {
            document.getElementById('no-animal-selected').classList.add('hidden');
            document.getElementById('no-records').classList.remove('hidden');
            document.getElementById('records-table').classList.add('hidden');
        }
        
       
        function showRecordsTable(records) {
            document.getElementById('no-animal-selected').classList.add('hidden');
            document.getElementById('no-records').classList.add('hidden');
            document.getElementById('records-table').classList.remove('hidden');
            
            const tbody = document.getElementById('records-tbody');
            tbody.innerHTML = '';
            
            records.forEach(record => {
                const row = document.createElement('tr');
             
                let statusHtml = record.status_kesehatan;
                if (record.status_kesehatan === 'Sehat') {
                    statusHtml = `<span class="health-status-healthy">${record.status_kesehatan}</span>`;
                } else if (record.status_kesehatan === 'Sakit') {
                    statusHtml = `<span class="health-status-sick">${record.status_kesehatan}</span>`;
                }
                
               
                let actionButtons = '';
                if (record.status_kesehatan === 'Sakit') {
                    actionButtons += `<button onclick="editRecord('${record.id_hewan}', '${record.tanggal_pemeriksaan}')" 
                                        class="action-button bg-blue-500 text-white">Edit</button>`;
                }
                actionButtons += `<button onclick="deleteRecord('${record.id_hewan}', '${record.tanggal_pemeriksaan}')" 
                                    class="action-button bg-red-500 text-white">Hapus</button>`;
                
                row.innerHTML = `
                    <td>${record.tanggal_display}</td>
                    <td>${record.nama_dokter}</td>
                    <td>${statusHtml}</td>
                    <td>${record.diagnosis}</td>
                    <td>${record.pengobatan}</td>
                    <td>${record.catatan_tindak_lanjut}</td>
                    <td>${actionButtons}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        
        
        function editRecord(idHewan, tanggalPemeriksaan) {
           
            document.getElementById('edit-form').action = 
                "{% url 'medical_checkup_feeding:edit_medical_record' '0' '0000-01-01' %}".replace('0/0000-01-01', idHewan + '/' + tanggalPemeriksaan);
            const record = medicalRecordsData.find(r => 
                r.id_hewan === idHewan && r.tanggal_pemeriksaan === tanggalPemeriksaan
            );
            
            if (record) {
                document.getElementById('diagnosis_baru').value = record.diagnosis !== '-' ? record.diagnosis : '';
                document.getElementById('pengobatan_baru').value = record.pengobatan !== '-' ? record.pengobatan : '';
                document.getElementById('catatan_tindak_lanjut').value = record.catatan_tindak_lanjut !== '-' ? record.catatan_tindak_lanjut : '';
            }
            
            document.getElementById('edit-record-modal').classList.remove('hidden');
        }
        
       
        function deleteRecord(idHewan, tanggalPemeriksaan) {
            document.getElementById('delete-form').action = 
                "{% url 'medical_checkup_feeding:delete_medical_record' '0' '0000-01-01' %}".replace('0/0000-01-01', idHewan + '/' + tanggalPemeriksaan);
            
            document.getElementById('delete-record-modal').classList.remove('hidden');
        }
        
       
        showNoAnimalSelected();
    </script>
</body>
</html>