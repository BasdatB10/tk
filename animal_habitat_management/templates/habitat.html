{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link href="https://fonts.googleapis.com/css2?family=Geist&family=Manrope:wght@400;600&display=swap" rel="stylesheet" />
	<script src="{% static 'alerts/alert.js' %}"></script>
	<link rel="stylesheet" href="{% static 'alerts/alert.css' %}">
	<script src="https://cdn.tailwindcss.com"></script>
	<title>Manajemen Habitat - SIZOPI</title>
	<style>
		body {
			font-family: 'Manrope', sans-serif;
			font-weight: 600;
			letter-spacing: -0.02em;
		}
	</style>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						palette1: '#FAD4B6',
						palette2: '#FBBE99',
						palette3: '#ED8764',
						palette4: '#DD6D49',
						palette5: '#883526',
						palette6: '#49241B',
					}
				}
			}
		}
	</script>
</head>
<body class="relative min-h-screen bg-white overflow-x-auto">
	<!-- Background Image -->
	<div class="absolute inset-0 -z-10">
		<img src="{% static 'images/animal-bg.jpeg' %}" alt="Background" class="w-full h-full object-cover opacity-5 saturate-50" />
	</div>

    <div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 z-40"></div>
    <div id="formModal" class="hidden fixed inset-0 flex items-center justify-center z-50 fade">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xl">
            <h2 class="text-2xl font-bold text-center text-palette5 mb-4">Form Tambah Habitat</h2>
            <form action="{% url 'animal_habitat_management:habitat' %}" method="POST" id="addHabitatForm" class="space-y-3">
                {% csrf_token %}
				<input type="hidden" name="original_nama" id="originalNamaInput">
                <div>
                    <label class="block text-palette6 text-sm mb-1">Nama Habitat</label>
                    <input name="nama" type="text" placeholder="Masukkan Nama Habitat" class="w-full px-3 py-2 text-sm border rounded-xl shadow focus:outline-none focus:ring-2 focus:ring-palette3" />
                </div>
                <div>
                    <label class="block text-palette6 text-sm mb-1">Luas Area (m²)</label>
                    <input name="luas_area" type="number" placeholder="Masukkan Luas Area" class="w-full px-3 py-2 text-sm border rounded-xl shadow focus:outline-none focus:ring-2 focus:ring-palette3" />
                </div>
                <div>
                    <label class="block text-palette6 text-sm mb-1">Kapasitas Maksimal Satwa</label>
                    <input name="kapasitas" type="number" placeholder="Masukkan Kapasitas Maksimal" class="w-full px-3 py-2 text-sm border rounded-xl shadow focus:outline-none focus:ring-2 focus:ring-palette3" />
                </div>
                <div>
                    <label class="block text-palette6 text-sm mb-1">Status Lingkungan</label>
                    <textarea name="status" placeholder="Masukkan Status Lingkungan di sini" class="w-full px-3 py-2 text-sm border rounded-xl shadow focus:outline-none focus:ring-2 focus:ring-palette3 resize-none" style="height: 6.25rem;"></textarea>
                </div>

                <div class="flex justify-between mt-4">
                    <button type="button" id="cancelButton" class="text-palette5 font-semibold text-sm">< Kembali</button>
                    <button type="submit" class="bg-palette5 hover:bg-palette6 text-white text-sm px-4 py-2 rounded-xl shadow">Selesai dan Tambah Habitat</button>
                </div>
            </form>
        </div>
    </div>

	<div id="mainContent" class="max-w-7xl mx-auto p-6">
		<h1 class="text-6xl font-extrabold text-palette5 text-center mb-10 drop-shadow-lg">Manajemen Habitat</h1>
		<div class="flex flex-col items-center mb-10 drop-shadow-lg">
			<div class="flex gap-32 justify-center">
				<div class="text-center">
					<div class="text-5xl font-extrabold text-palette5">{{ jumlah_habitat }}</div>
					<div class="text-base text-palette6 mt-2">Jumlah Habitat</div>
				</div>
				<div class="text-center">
					<div class="text-5xl font-extrabold text-green-600">{{ kapasitas_total }}</div>
					<div class="text-base text-palette6 mt-2">Satwa Dapat Ditampung</div>
				</div>
			</div>
		</div>

		<div class="overflow-x-auto bg-white rounded-2xl shadow-2xl p-6">
			<div class="flex justify-between items-center mb-6">
				<div class="flex items-center gap-4">
					<span class="text-palette6 text-base font-semibold">Tampilan Data Habitat 1-{{ jumlah_habitat }}</span>
				</div>
				<button id="openFormButton" class="bg-palette5 hover:bg-palette6 text-white px-6 py-2 rounded-2xl shadow">
                    Tambah Habitat
                </button>
			</div>
			<table class="min-w-full table-auto">
				<thead class="bg-palette2">
					<tr>
						<th class="px-6 py-4 text-center font-bold">Nama Habitat</th>
						<th class="px-6 py-4 text-center font-bold">Luas Area (m²)</th>
						<th class="px-6 py-4 text-center font-bold">Kapasitas Maksimal</th>
						<th class="px-6 py-4 text-center font-bold">Status Lingkungan</th>
						<th class="px-16 py-4 text-center font-bold">Aksi</th>
					</tr>
				</thead>
				<tbody>
                    {% for habitat in habitat_data %}
                    <tr class="{% cycle 'bg-palette1' 'bg-white' %}">
                        <td class="px-6 py-4 text-center">{{ habitat.nama }}</td>
                        <td class="px-6 py-4 text-center">{{ habitat.luas_area }}</td>
                        <td class="px-6 py-4 text-center">{{ habitat.kapasitas }}</td>
                        <td class="px-6 py-4 text-center">{{ habitat.status }}</td>
                        <td class="px-16 py-4 text-center">
                            <div class="flex justify-center gap-2">
                                <a href="{% url 'animal_habitat_management:habitat_detail' %}?nama={{ habitat.nama }}">
									<button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-2xl">
										Detail
									</button>
								</a>
                                <button 
									class="bg-palette3 hover:bg-palette4 text-white px-4 py-2 rounded-2xl editHabitatButton"
									data-nama="{{ habitat.nama }}"
									data-luas="{{ habitat.luas_area }}"
									data-kapasitas="{{ habitat.kapasitas }}"
									data-status="{{ habitat.status }}"
								>Edit</button>
                                <form method="POST" action="{% url 'animal_habitat_management:habitat_delete' %}" style="display:inline;">
									{% csrf_token %}
									<input type="hidden" name="nama" value="{{ habitat.nama }}">
									<button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-2xl">
										Delete
									</button>
								</form>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="text-center py-6 text-palette6">Belum ada habitat tercatat.</td></tr>
                    {% endfor %}
                </tbody>
			</table>
		</div>
	</div>

    <script>
        const openFormButton = document.getElementById('openFormButton');
        const cancelButton = document.getElementById('cancelButton');
        const formModal = document.getElementById('formModal');
        const overlay = document.getElementById('overlay');
        const body = document.body;

		document.querySelectorAll('.editHabitatButton').forEach(button => {
			button.addEventListener('click', () => {
				const nama = button.dataset.nama;
				const luas = button.dataset.luas;
				const kapasitas = button.dataset.kapasitas;
				const status = button.dataset.status;

				document.querySelector('input[name="nama"]').value = nama;
				document.querySelector('input[name="luas_area"]').value = luas;
				document.querySelector('input[name="kapasitas"]').value = kapasitas;
				document.querySelector('textarea[name="status"]').value = status;
				document.getElementById('originalNamaInput').value = nama;

				document.querySelector('#formModal h2').textContent = `Edit Habitat: ${nama}`;
				document.querySelector('#addHabitatForm button[type="submit"]').textContent = 'Simpan Perubahan';

				formModal.classList.remove('hidden');
				overlay.classList.remove('hidden');
				body.classList.add('overflow-hidden');
				body.style.paddingRight = '15px';
			});
		});

        openFormButton.addEventListener('click', () => {
            formModal.classList.remove('hidden');
            overlay.classList.remove('hidden');
            body.classList.add('overflow-hidden');
            body.style.paddingRight = '15px';

			document.getElementById('originalNamaInput').value = '';
			document.querySelector('#formModal h2').textContent = 'Form Tambah Habitat';
			document.querySelector('#addHabitatForm button[type="submit"]').textContent = 'Selesai dan Tambah Habitat';
			document.getElementById('addHabitatForm').reset();
        });

        cancelButton.addEventListener('click', () => {
            formModal.classList.add('hidden');
            overlay.classList.add('hidden');
            body.classList.remove('overflow-hidden');
            body.style.paddingRight = '0';
        });

        document.getElementById('addHabitatForm').addEventListener('submit', (e) => {
            e.preventDefault();
            formModal.classList.add('hidden');
            overlay.classList.add('hidden');
            body.classList.remove('overflow-hidden');
            body.style.paddingRight = '0';
        });

        const form = document.getElementById('addHabitatForm');
		if (form) {
			form.addEventListener("submit", async function (e) {
				e.preventDefault();
				const formData = new FormData(this);
				try {
					const response = await fetch("", {
						method: "POST",
						body: formData,
						headers: {
							'X-Requested-With': 'XMLHttpRequest',
							'X-CSRFToken': formData.get('csrfmiddlewaretoken')
						}
					});

					const result = await response.json();
					if (result.success) {
						showAlert(result.message, () => {
							window.location.href = '/animal/habitat/';
						});
					} else {
						showAlert(result.message);
					}
				} catch (err) {
					showAlert("Terjadi kesalahan saat menambahkan/mengubah data habitat.");
				}
			});
		}
    </script>
</body>
</html>